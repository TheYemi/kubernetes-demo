name: Build and Deploy

on:
  push:
    branches: [main]
    paths:
      - 'application/**'

permissions:
  contents: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'application/api/**'
            frontend:
              - 'application/frontend/**'

  build-api:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build API image
        run: |
          docker build -t theyemiii/task-api:${{ github.sha }} \
                       -t theyemiii/task-api:latest \
                       application/api/

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: theyemiii/task-api:${{ github.sha }}
          format: table
          severity: CRITICAL
          exit-code: 1

      - name: Push API image
        run: |
          docker push theyemiii/task-api:${{ github.sha }}
          docker push theyemiii/task-api:latest

      - name: Update API deployment manifest
        run: |
          sed -i "s|image: theyemiii/task-api:.*|image: theyemiii/task-api:${{ github.sha }}|" \
            kubernetes/production/api-deployment.yaml

      - name: Commit and push manifest change
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add kubernetes/production/api-deployment.yaml
          git commit -m "ci: update api image to ${{ github.sha }}"
          git push

  build-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build frontend image
        run: |
          docker build -t theyemiii/task-frontend:${{ github.sha }} \
                       -t theyemiii/task-frontend:latest \
                       application/frontend/

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: theyemiii/task-frontend:${{ github.sha }}
          format: table
          severity: CRITICAL
          exit-code: 1

      - name: Push frontend image
        run: |
          docker push theyemiii/task-frontend:${{ github.sha }}
          docker push theyemiii/task-frontend:latest

      - name: Update frontend deployment manifest
        run: |
          sed -i "s|image: theyemiii/task-frontend:.*|image: theyemiii/task-frontend:${{ github.sha }}|" \
            kubernetes/production/frontend-deployment.yaml

      - name: Commit and push manifest change
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add kubernetes/production/frontend-deployment.yaml
          git commit -m "ci: update frontend image to ${{ github.sha }}"
          git push
