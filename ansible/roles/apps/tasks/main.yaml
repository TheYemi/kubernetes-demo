---
- name: Wait for all nodes to be Ready
  become_user: ubuntu
  shell: |
    NOT_READY=$(kubectl get nodes --no-headers | grep -v " Ready " | wc -l)
    echo $NOT_READY
  register: not_ready_nodes
  retries: 30
  delay: 10
  until: not_ready_nodes.stdout | trim == "0"

- name: Install metrics-server
  become_user: ubuntu
  command: kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
  register: metrics_install
  retries: 3
  delay: 10
  until: metrics_install.rc == 0

- name: Patch metrics-server for self-managed cluster
  become_user: ubuntu
  command: >
    kubectl patch deployment metrics-server -n kube-system
    --type='json'
    -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
  register: patch_result
  retries: 3
  delay: 10
  until: patch_result.rc == 0

- name: Wait for metrics-server to be ready
  become_user: ubuntu
  shell: |
    kubectl get pods -n kube-system -l k8s-app=metrics-server --no-headers | grep -v "Running" | wc -l
  register: metrics_pods
  retries: 30
  delay: 10
  until: metrics_pods.stdout | trim == "0"

- name: Install Sealed Secrets controller
  become_user: ubuntu
  command: >
    kubectl apply -f
    https://github.com/bitnami-labs/sealed-secrets/releases/latest/download/controller.yaml
  register: sealed_install
  retries: 3
  delay: 10
  until: sealed_install.rc == 0

- name: Wait for Sealed Secrets controller to be ready
  become_user: ubuntu
  shell: |
    kubectl get pods -n kube-system -l name=sealed-secrets-controller --no-headers | grep -v "Running" | wc -l
  register: sealed_pods
  retries: 30
  delay: 10
  until: sealed_pods.stdout | trim == "0"

- name: Install AWS EBS CSI Driver
  become_user: ubuntu
  command: >
    kubectl apply -k "github.com/kubernetes-sigs/aws-ebs-csi-driver/deploy/kubernetes/overlays/stable/?ref=release-1.36"
  register: ebs_csi_install
  retries: 3
  delay: 10
  until: ebs_csi_install.rc == 0

- name: Wait for EBS CSI Driver controller to be ready
  become_user: ubuntu
  shell: |
    kubectl get pods -n kube-system -l app=ebs-csi-controller --no-headers | grep -v "Running" | wc -l
  register: ebs_csi_controller
  retries: 30
  delay: 10
  until: ebs_csi_controller.stdout | trim == "0"

- name: Wait for EBS CSI Driver node pods to be ready
  become_user: ubuntu
  shell: |
    kubectl get pods -n kube-system -l app=ebs-csi-node --no-headers | grep -v "Running" | wc -l
  register: ebs_csi_node
  retries: 30
  delay: 10
  until: ebs_csi_node.stdout | trim == "0"

- name: Install NGINX Ingress Controller
  become_user: ubuntu
  command: >
    kubectl apply -f
    https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.0/deploy/static/provider/baremetal/deploy.yaml
  register: ingress_install
  retries: 3
  delay: 10
  until: ingress_install.rc == 0

- name: Wait for Ingress Controller to be ready
  become_user: ubuntu
  shell: |
    kubectl get pods -n ingress-nginx -l app.kubernetes.io/component=controller --no-headers | grep -v "Running" | wc -l
  register: ingress_pods
  retries: 30
  delay: 10
  until: ingress_pods.stdout | trim == "0"

- name: Patch NGINX Ingress to use NodePort 30080
  become_user: ubuntu
  command: >
    kubectl patch svc ingress-nginx-controller -n ingress-nginx
    --type='json'
    -p='[{"op": "replace", "path": "/spec/ports/0/nodePort", "value": 30080}]'
  register: ingress_patch
  retries: 3
  delay: 10
  until: ingress_patch.rc == 0