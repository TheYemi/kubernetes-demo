---
- name: Wait for all nodes to be Ready
  become_user: ubuntu
  shell: |
    NOT_READY=$(kubectl get nodes --no-headers | grep -v " Ready " | wc -l)
    echo $NOT_READY
  register: not_ready_nodes
  retries: 30
  delay: 10
  until: not_ready_nodes.stdout | trim == "0"

- name: Create directories for manifests
  file:
    path: "/home/ubuntu/k8s-manifests/{{ item }}"
    state: directory
    owner: ubuntu
    group: ubuntu
  loop:
    - storage
    - app
    - monitoring

- name: Copy storage manifests
  copy:
    src: "{{ playbook_dir }}/../kubernetes/storage/"
    dest: /home/ubuntu/k8s-manifests/storage/
    owner: ubuntu
    group: ubuntu

- name: Copy app manifests
  copy:
    src: "{{ playbook_dir }}/../kubernetes/app/"
    dest: /home/ubuntu/k8s-manifests/app/
    owner: ubuntu
    group: ubuntu

- name: Copy monitoring manifests
  copy:
    src: "{{ playbook_dir }}/../kubernetes/monitoring/"
    dest: /home/ubuntu/k8s-manifests/monitoring/
    owner: ubuntu
    group: ubuntu

- name: Copy network policy manifests
  copy:
    src: "{{ playbook_dir }}/../kubernetes/network-policies/"
    dest: /home/ubuntu/k8s-manifests/network-policies/
    owner: ubuntu
    group: ubuntu

- name: Create data directories on workers for PVs
  delegate_to: "{{ item }}"
  file:
    path: "{{ dir }}"
    state: directory
    mode: '0777'
  loop: "{{ groups['role_worker'] }}"
  loop_control:
    loop_var: item
  vars:
    dir: "/data/redis"
  ignore_errors: true

- name: Apply storage manifests
  become_user: ubuntu
  command: kubectl apply -f /home/ubuntu/k8s-manifests/storage/
  register: storage_apply
  retries: 3
  delay: 10
  until: storage_apply.rc == 0

- name: Apply app manifests
  become_user: ubuntu
  command: kubectl apply -f /home/ubuntu/k8s-manifests/app/
  register: app_apply
  retries: 3
  delay: 10
  until: app_apply.rc == 0

- name: Create monitoring namespace
  become_user: ubuntu
  command: kubectl create namespace monitoring
  register: ns_result
  failed_when: ns_result.rc != 0 and "already exists" not in ns_result.stderr

- name: Apply monitoring manifests
  become_user: ubuntu
  command: kubectl apply -f /home/ubuntu/k8s-manifests/monitoring/
  register: monitoring_apply
  retries: 3
  delay: 10
  until: monitoring_apply.rc == 0

- name: Apply network policy manifests
  become_user: ubuntu
  command: kubectl apply -f /home/ubuntu/k8s-manifests/network-policies/
  register: netpol_apply
  retries: 3
  delay: 10
  until: netpol_apply.rc == 0

- name: Wait for app pods to be ready
  become_user: ubuntu
  shell: |
    kubectl get pods --no-headers | grep -v "Running\|Completed" | wc -l
  register: pending_pods
  retries: 30
  delay: 10
  until: pending_pods.stdout | trim == "0"

- name: Display cluster status
  become_user: ubuntu
  command: kubectl get nodes,pods -A -o wide
  register: cluster_status

- name: Show cluster status
  debug:
    var: cluster_status.stdout_lines