---
- name: Wait for all nodes to be Ready
  become_user: ubuntu
  shell: |
    NOT_READY=$(kubectl get nodes --no-headers | grep -v " Ready " | wc -l)
    echo $NOT_READY
  register: not_ready_nodes
  retries: 30
  delay: 10
  until: not_ready_nodes.stdout | trim == "0"

- name: Create data directories on workers for PVs
  delegate_to: "{{ item }}"
  file:
    path: "{{ dir }}"
    state: directory
    mode: '0777'
  loop: "{{ groups['role_worker'] }}"
  loop_control:
    loop_var: item
  vars:
    dir: "/data/redis"
  ignore_errors: true

- name: Install metrics-server
  become_user: ubuntu
  command: kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
  register: metrics_install
  retries: 3
  delay: 10
  until: metrics_install.rc == 0

- name: Patch metrics-server for self-managed cluster
  become_user: ubuntu
  command: >
    kubectl patch deployment metrics-server -n kube-system
    --type='json'
    -p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--kubelet-insecure-tls"}]'
  register: patch_result
  retries: 3
  delay: 10
  until: patch_result.rc == 0

- name: Wait for metrics-server to be ready
  become_user: ubuntu
  shell: |
    kubectl get pods -n kube-system -l k8s-app=metrics-server --no-headers | grep -v "Running" | wc -l
  register: metrics_pods
  retries: 30
  delay: 10
  until: metrics_pods.stdout | trim == "0"

- name: Install Sealed Secrets controller
  become_user: ubuntu
  command: >
    kubectl apply -f
    https://github.com/bitnami-labs/sealed-secrets/releases/latest/download/controller.yaml
  register: sealed_install
  retries: 3
  delay: 10
  until: sealed_install.rc == 0

- name: Wait for Sealed Secrets controller to be ready
  become_user: ubuntu
  shell: |
    kubectl get pods -n kube-system -l name=sealed-secrets-controller --no-headers | grep -v "Running" | wc -l
  register: sealed_pods
  retries: 30
  delay: 10
  until: sealed_pods.stdout | trim == "0"