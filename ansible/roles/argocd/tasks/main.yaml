---
- name: Create argocd namespace
  become_user: ubuntu
  command: kubectl create namespace argocd
  register: argocd_ns
  failed_when: argocd_ns.rc != 0 and "already exists" not in argocd_ns.stderr

- name: Install ArgoCD
  become_user: ubuntu
  command: kubectl apply -n argocd --server-side=true -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
  register: argocd_install
  retries: 3
  delay: 10
  until: argocd_install.rc == 0

- name: Wait for ArgoCD pods to be ready
  become_user: ubuntu
  shell: |
    kubectl get pods -n argocd --no-headers | grep -v "Running" | wc -l
  register: argocd_pods
  retries: 30
  delay: 10
  until: argocd_pods.stdout | trim == "0"

- name: Patch ArgoCD server to NodePort
  become_user: ubuntu
  command: >
    kubectl patch svc argocd-server -n argocd
    --type='json'
    -p='[{"op": "replace", "path": "/spec/type", "value": "NodePort"},
         {"op": "replace", "path": "/spec/ports/0/nodePort", "value": 30443}]'
  register: patch_result
  failed_when: patch_result.rc != 0 and "already patched" not in patch_result.stderr

- name: Get ArgoCD initial admin password
  become_user: ubuntu
  shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_password

- name: Display ArgoCD credentials
  debug:
    msg: "ArgoCD URL: http://<ALB_DNS>:30443 | Username: admin | Password: {{ argocd_password.stdout }}"
  
- name: Copy ArgoCD bootstrap manifest
  copy:
    src: "{{ playbook_dir }}/../kubernetes/argocd/bootstrap.yaml"
    dest: /home/ubuntu/k8s-manifests/argocd/bootstrap.yaml
    owner: ubuntu
    group: ubuntu

- name: Apply ArgoCD bootstrap application
  become_user: ubuntu
  command: kubectl apply -f /home/ubuntu/k8s-manifests/argocd/bootstrap.yaml
  register: bootstrap_apply
  retries: 3
  delay: 10
  until: bootstrap_apply.rc == 0